{"version":3,"sources":["../js/lobby.js"],"names":["LOBBY","coundownTime","setupLink","$","val","location","href","focusOnInput","focus","startCountdown","callback","log","showLayer","countdown","n","text","setTimeout","revealGame","hideLayer","css_selector","css","disconnect","msg","socket","ENV","storage","ongoing","alert","reset","hideGame","showResults","results","game","RESULTS","load","TIME","sec","endSimulation","lobby","info","type","spectate","old_rank","user","simple_rank","old_money","simple_money","updateStatsAjax","updateStatsChanges","wait","revealLobby","new_rank","new_money","console","User","calculateRankLetter","calculateRankNumber","deltaRank","deltaMoney","setAnimationTimeout","dt","elapsed","timeout","percent","rank","Math","round","parseInt","money","DeepSpaceGame","runningInstance","deinit","disableInput","attr","enableInput","removeAttr","lobbyStatus","m","showHelpButton","hideHelpButton","setClock","interval","seconds","minutes","floor","remaining_seconds","str","writeClock","refreshClock","overtime","timer","timeLeft","disabled","code","password","game_settings","map","player_capacity","mode","stock","players","spectators"],"mappings":"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","file":"lobby.js","sourcesContent":["\nlet LOBBY = {\n\n  coundownTime: 3,\n\n  setupLink() {\n    $('#lobbylink').val(location.href);\n  },\n\n  focusOnInput() {\n    $('#name-input').focus();\n  },\n\n  startCountdown(callback) { log(`starting countdown...`);\n    this.showLayer('#countdown_layer');\n\n    var countdown = (n = this.coundownTime) => {\n      $('#countdown').text(n>0 ? n : 'GO');\n      if(n-- >= 0) setTimeout(()=>{countdown(n)}, 1000);\n    };\n\n    countdown();\n    setTimeout(()=>{this.revealGame(callback)}, this.coundownTime*1000);\n  },\n\n  revealGame(callback) {\n    this.hideLayer('#menu_layer');\n    if(callback) callback();\n    setTimeout(()=>{ this.hideLayer('#countdown_layer'); }, 600);\n  },\n\n  hideLayer(css_selector) {\n    $(css_selector).css('opacity', '0');\n    setTimeout(()=>{\n      $(css_selector).css('display', 'none');\n    }, 1000);\n  },\n  showLayer(css_selector) {\n    $(css_selector).css('display', 'initial');\n    setTimeout(()=>{\n      $(css_selector).css('opacity', '1');\n    }, 10);\n  },\n\n  disconnect(msg = `A network error occured`) {\n    socket.disconnect();\n    ENV.storage.ongoing = false;\n    alert(msg);\n    location.reset();\n  },\n\n  /*\n   *  LOBBY.disableGame: stops interaction with the game and partially hides it from view. Serves as an interlude while waiting\n   *  for any last server operations. Usually seceded by LOBBY.showResults\n   *  part 1 of 2 in closing a match\n   */\n  hideGame() {\n\n    // fades in the overlay\n    $('#countdown').text('FINISH');\n    this.showLayer('#countdown_layer');\n    // $('#game_layer').css('filter', 'blur(4px)');\n\n    // // hides unnecessary game UI\n    // LOBBY.hideHelpButton();\n    //\n    // // stops game interaction\n    // ENV.game.disableInteraction();\n\n  },\n\n  /*\n   *  LOBBY.showResults: upon server command, gets the game results (team scores, kills, and user rank change) prepared,\n   *  displayed and eventually removed\n   *  part 2 of 2 in closing a match\n   */\n  showResults(results) {\n\n\n    // load results into HTML\n    var game = ENV.game;\n    RESULTS.load(results);\n\n\n    // unveil results\n    //  stage 1 - show results underneath\n    setTimeout(()=>{this.showLayer('#results_layer');}, TIME.sec(0.5));\n    //  stage 2 - remove overlay to reveal results\n    setTimeout(()=>{\n      game.endSimulation();\n      this.hideLayer('#countdown_layer');\n    }, TIME.sec(1));\n    //  stage 3 - unblur the game layer (after, since it can be expensive) -- cross that (currently disabled for performance)\n    // setTimeout(()=>{$('#game_layer').css('filter', 'blur(0px)');}, TIME.sec(2));\n\n\n    // perform extra tasks for ranked lobbies\n    if(ENV.lobby.info.type == 0 && !ENV.spectate) {\n\n      const old_rank = ENV.user.simple_rank || 0;\n      const old_money = ENV.user.simple_money || 0;\n      ENV.user.updateStatsAjax();\n\n      ENV.storage.ongoing = false;\n\n      (()=>{this.updateStatsChanges(old_rank, ENV.user.simple_rank, old_money, ENV.user.simple_money)}).wait(TIME.sec(5))\n\n    }\n\n\n    setTimeout(()=>{this.revealLobby();}, TIME.sec(8));\n  },\n\n  revealLobby() {\n    // PARTICLES.start();\n    this.showLayer('#menu_layer');\n    setTimeout(()=>{this.hideLayer('#results_layer');}, TIME.sec(1));\n  },\n\n  updateStatsChanges(old_rank, new_rank, old_money, new_money) {\n    console.log(`RANK OLD ${old_rank}`, `NEW ${new_rank}`);\n    console.log(`MONEY OLD ${old_money}`, `NEW ${new_money}`);\n    $('#re_rank_group_value').text(`${User.calculateRankLetter(old_rank)} - ${User.calculateRankNumber(old_rank)}`);\n    $('#re_money_group_value').text(`$ ${old_money}`);\n    this.showLayer('#results_effect_layer');\n\n    const deltaRank = new_rank - old_rank;\n    const deltaMoney = new_money - old_money;\n\n    setTimeout(() => {\n      setAnimationTimeout((dt, elapsed, timeout) => {\n\n        const percent = elapsed / timeout;\n        const rank = Math.round(parseInt(old_rank) + (deltaRank * percent));\n        const money = Math.round(parseInt(old_money) + (deltaMoney * percent));\n        $('#re_rank_group_value').text(`${User.calculateRankLetter(rank)} - ${User.calculateRankNumber(rank)}`);\n        $('#re_money_group_value').text(`$ ${money}`);\n\n      }, 1);\n    }, TIME.sec(1));\n\n\n    // (()=>{\n    //   var ms_delay = 20,\n    //       animate_length = 1000,\n    //       frame_count = animate_length / ms_delay,\n    //       rank_delta = new_rank - old_rank;\n    //\n    //   frame_count.times(i => {\n    //     var progress = (++i) / frame_count,\n    //         current_rank = Math.round(parseInt(old_rank) + (rank_delta*progress)),\n    //         wait_time = ms_delay*i;\n    //     (()=>{$('#re_rank_group_value').text(`${User.calculateRankLetter(old_rank)} - ${User.calculateRankNumber(current_rank)}`);}).wait(wait_time);\n    //   })\n    // }).wait(1000);\n\n\n    // $('#countdown').text('FINISH');\n    // this.showLayer('#countdown_layer');\n    (()=>{\n      this.hideLayer('#results_effect_layer');\n      if(DeepSpaceGame.runningInstance) DeepSpaceGame.runningInstance.deinit();\n    }).wait(TIME.sec(3.5))\n  },\n\n\n  disableInput() {\n    $('input').attr('disabled')\n    $('select').attr('disabled')\n  },\n\n  enableInput() {\n    $('input').removeAttr('disabled')\n    $('select').removeAttr('disabled')\n  },\n\n  lobbyStatus(m) {\n    $('#lobby-status').text(m)\n  },\n\n  showHelpButton() {\n    $('#help_icon').removeAttr('hidden')\n  },\n  hideHelpButton() {\n    $('#help_icon').attr('hidden')\n  },\n\n  setClock(interval) {\n    // interval -= TIME.sec(10);\n\n    if(interval < 0) interval = 0;\n\n    let seconds = Math.round(interval/1000),\n      minutes = Math.floor(seconds/60),\n      remaining_seconds = seconds % 60;\n    if(remaining_seconds < 10) remaining_seconds = \"0\" + remaining_seconds;\n    let str = `${minutes}:${remaining_seconds}`;\n\n    LOBBY.writeClock(str);\n  },\n\n  writeClock(str) {\n    $('#clock').text(str);\n  },\n\n  refreshClock() {\n    ENV.game.game.overtime ? LOBBY.writeClock('OVERTIME') : LOBBY.setClock(ENV.game.timer.timeLeft);\n    // LOBBY.setClock(ENV.game.timer.timeLeft);\n    if(!ENV.game.game.disabled) setTimeout(()=>{ LOBBY.refreshClock() }, 1000);\n  }\n\n\n};\n\n\nENV.lobby = {\n  code: null,\n  password: null,\n  game_settings: {\n    map: null,\n    player_capacity: null,\n    mode: null,\n    stock: null\n  },\n  players: [\n    // {name, rank, team, ready, ship, slots []}\n  ],\n  spectators: [\n    // {name}\n  ]\n};\n"]}