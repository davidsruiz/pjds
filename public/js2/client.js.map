{"version":3,"sources":["../js/client.js"],"names":["Lobby","info","type","code","password","game_settings","map","player_capacity","mode","stock","players","spectators","user","isJoined","isReady","team","userIsJoined","socketSetup","network","GameNetworkAdapter","socket","window","onbeforeunload","beforeExit","io","connect","on","alert","msg","a","auth","connected","passwordSet","passwordCleared","joined","lobbyFull","starting","usersUpdate","playersUpdate","optionsUpdate","gameStarted","gameEnded","disconnected","lobbyID","location","pathname","slice","data","ENV","id","name","emit","prompt","history","back","lobby_ui","render","lobbyType","join","UA","getName","getTeam","get_rank","then","rank","catch","shipType","newUsersData","users","key","value","editableSettings","p","getPassword","setupData","ongoing","spectate","game","DeepSpaceGame","create","friends","addHistory","_","reject","listen","LOBBY","startCountdown","start","refreshClock","results","console","log","stopListening","end","hideGame","setTimeout","showResults","TIME","sec","isOngoing","isPlaying","isPublicLobby","storage","$","Friends","lobby","LobbyUI","regex","validation","test","swearjar","profane","trim","resolve","max_team_count","noneditableSettings","maxTeams","solo_option","result","userCanceledDialog","isNotANumber","isNaN","Number","isUnderBounds","isOverBounds","ReactDOM","document","getElementById"],"mappings":";;;;;;;;AACA;AACA;AACA;;;IAGMA,K;AAEJ,mBAAc;AAAA;;AAAA;;AAEZ,SAAKC,IAAL,GAAY;AACVC,YAAM,IADI;AAEVC,YAAM,IAFI;AAGVC,gBAAU,IAHA;AAIVC,qBAAe;AACbC,aAAK,IADQ;AAEbC,yBAAiB,IAFJ;AAGbC,cAAM,IAHO;AAIbC,eAAO;AAJM,OAJL;AAUVC,eAAS;AACP;AADO,OAVC;AAaVC,kBAAY;AACV;AADU;AAbF,KAAZ;;AAkBA,SAAKC,IAAL,GAAY;AACVC,gBAAU,KADA;AAEVC,eAAS,KAFC;AAGVC,YAAM;AAHI,KAAZ;AAKA,SAAKC,YAAL,GAAoB,KAApB;;AAEA,SAAKC,WAAL;AACA,SAAKC,OAAL,GAAe,IAAIC,kBAAJ,CAAuB,IAAvB,EAA6B,KAAKC,MAAlC,CAAf;;AAEAC,WAAOC,cAAP,GAAwB;AAAA,aAAM,MAAKC,UAAL,EAAN;AAAA,KAAxB;AAED;;;;kCAEa;AAAA;;AACZ,UAAIH,SAAS,KAAKA,MAAL,GAAcI,GAAGC,OAAH,EAA3B;;AAEAL,aAAOM,EAAP,CAAU,KAAV,EAAiB,YAAI;AAACC,cAAM,UAAN;AAAkB,OAAxC;AACAP,aAAOM,EAAP,CAAU,OAAV,EAAmB,UAACE,GAAD,EAAO;AAACD,mCAAyBC,GAAzB;AAAgC,OAA3D;;AAEA;;AAEA;AACA;AACAR,aAAOM,EAAP,CAAU,MAAV,EAAkB,UAACG,CAAD;AAAA,eAAK,OAAKC,IAAL,CAAUD,CAAV,CAAL;AAAA,OAAlB;AACAT,aAAOM,EAAP,CAAU,WAAV,EAAuB,UAACG,CAAD;AAAA,eAAK,OAAKE,SAAL,CAAeF,CAAf,CAAL;AAAA,OAAvB;AACAT,aAAOM,EAAP,CAAU,aAAV,EAAyB,UAACG,CAAD;AAAA,eAAK,OAAKG,WAAL,CAAiBH,CAAjB,CAAL;AAAA,OAAzB;AACAT,aAAOM,EAAP,CAAU,iBAAV,EAA6B,UAACG,CAAD;AAAA,eAAK,OAAKI,eAAL,CAAqBJ,CAArB,CAAL;AAAA,OAA7B;;AAEAT,aAAOM,EAAP,CAAU,QAAV,EAAoB,UAACG,CAAD;AAAA,eAAK,OAAKK,MAAL,CAAYL,CAAZ,CAAL;AAAA,OAApB;AACAT,aAAOM,EAAP,CAAU,WAAV,EAAuB,UAACG,CAAD;AAAA,eAAK,OAAKM,SAAL,CAAeN,CAAf,CAAL;AAAA,OAAvB;AACAT,aAAOM,EAAP,CAAU,UAAV,EAAsB,UAACG,CAAD;AAAA,eAAK,OAAKO,QAAL,CAAcP,CAAd,CAAL;AAAA,OAAtB;;AAEAT,aAAOM,EAAP,CAAU,aAAV,EAAyB,UAACG,CAAD;AAAA,eAAK,OAAKQ,WAAL,CAAiBR,CAAjB,CAAL;AAAA,OAAzB;AACAT,aAAOM,EAAP,CAAU,eAAV,EAA2B,UAACG,CAAD;AAAA,eAAK,OAAKS,aAAL,CAAmBT,CAAnB,CAAL;AAAA,OAA3B;AACAT,aAAOM,EAAP,CAAU,eAAV,EAA2B,UAACG,CAAD;AAAA,eAAK,OAAKU,aAAL,CAAmBV,CAAnB,CAAL;AAAA,OAA3B;;AAEAT,aAAOM,EAAP,CAAU,aAAV,EAAyB,UAACG,CAAD;AAAA,eAAK,OAAKW,WAAL,CAAiBX,CAAjB,CAAL;AAAA,OAAzB;AACAT,aAAOM,EAAP,CAAU,WAAV,EAAuB,UAACG,CAAD;AAAA,eAAK,OAAKY,SAAL,CAAeZ,CAAf,CAAL;AAAA,OAAvB;;AAEAT,aAAOM,EAAP,CAAU,cAAV,EAA0B,UAACG,CAAD;AAAA,eAAK,OAAKa,YAAL,CAAkBb,CAAlB,CAAL;AAAA,OAA1B;AACD;;;8BAGS;;AAER;AACA,UAAIc,UAAUtB,OAAOuB,QAAP,CAAgBC,QAAhB,CAAyBC,KAAzB,CAA+B,CAA/B,CAAd;;AACI;;AAEAC,aAAO,CAACJ,OAAD,EAAUK,IAAIpC,IAAJ,CAASqC,EAAnB,EAAuBD,IAAIpC,IAAJ,CAASsC,IAAhC,CAHX;;AAKA,WAAK9B,MAAL,CAAY+B,IAAZ,CAAiB,SAAjB,EAA4BJ,IAA5B;AACD;;;2BAEM;;AAEL,UAAI3C,WAAWiB,OAAO+B,MAAP,CAAc,gDAAd,CAAf;;AAEA;AACA,UAAGhD,aAAa,IAAhB,EAAsB;AACpBiD,gBAAQC,IAAR;AACA;AACD;;AAED;AACA,UAAIX,UAAUtB,OAAOuB,QAAP,CAAgBC,QAAhB,CAAyBC,KAAzB,CAA+B,CAA/B,CAAd;;AACE;AACAC,aAAO,CAACJ,OAAD,EAAUvC,QAAV,CAFT;;AAIA,WAAKgB,MAAL,CAAY+B,IAAZ,CAAiB,MAAjB,EAAyBJ,IAAzB;AACD;;;8BAESA,I,EAAM;AACd;;AAEAC,UAAIpC,IAAJ,CAASqC,EAAT,GAAcF,KAAK,CAAL,CAAd;;AAEA,WAAK9C,IAAL,GAAY8C,KAAK,CAAL,CAAZ;;AAEA;AACAC,UAAIO,QAAJ,CAAaC,MAAb;;AAEA;AACA;AACA,UAAMC,YAAY,KAAKxD,IAAL,CAAUC,IAA5B;AACA,UAAGuD,aAAa,CAAb,IAAkBA,aAAa,CAAlC,EAAqC,KAAKC,IAAL;AACtC;;;2BAEM;AAAA;;AAEL;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,UAAG,CAACV,IAAIpC,IAAJ,CAASsC,IAAb,EAAmBF,IAAIW,EAAJ,CAAOC,OAAP;;AAEnB;AACA,cAAO,KAAK3D,IAAL,CAAUC,IAAjB;AACE,aAAK,CAAL;AAAQ;AACN,eAAKU,IAAL,CAAUG,IAAV,GAAiB,IAAjB;AACA;AACF,aAAK,CAAL;AAAQ;AACN,cAAG,CAAC,KAAKH,IAAL,CAAUG,IAAV,GAAiBiC,IAAIO,QAAJ,CAAaM,OAAb,EAAlB,MAA8C,IAAjD,EAAuD;AACvD;AACF,aAAK,CAAL;AAAQ;AACN,eAAKjD,IAAL,CAAUG,IAAV,GAAiB,CAAjB;AACA;AATJ;;AAYA;AACAiC,UAAIpC,IAAJ,CAASkD,QAAT,CAAkBC,IAAlB,CAAuB,gBAAQ;;AAE7B,YAAIhB,OAAO,CAACC,IAAIpC,IAAJ,CAASsC,IAAV,EAAgBc,IAAhB,EAAsB,OAAKpD,IAAL,CAAUG,IAAhC,CAAX;AACA,eAAKK,MAAL,CAAY+B,IAAZ,CAAiB,MAAjB,EAAyBJ,IAAzB;AAED,OALD,EAKGkB,KALH,CAKS,YAAI;AACXtC,cAAM,sBAAN;AACD,OAPD;;AAUA;AACA;AACA;AACA;AACA;AACA;AACA;AAED;;;6BAEQ;AACP,WAAKf,IAAL,CAAUC,QAAV,GAAqB,IAArB;AACAmC,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;gCAEW;AACVR,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;0BAEKU,Q,EAAU;;AAEd;AACA;;AAEA;AACA;;AAEA,WAAK9C,MAAL,CAAY+B,IAAZ,CAAiB,OAAjB,EAA0Be,QAA1B;AAED;;;+BAEU;AACT,WAAKtD,IAAL,CAAUE,OAAV,GAAoB,IAApB;AACAkC,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;gCAEWW,Y,EAAc;AACxB,WAAKlE,IAAL,CAAUmE,KAAV,GAAkBD,YAAlB;AACAnB,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;kCAEaW,Y,EAAc;AAC1B,WAAKlE,IAAL,CAAUmE,KAAV,CAAgB1D,OAAhB,GAA0ByD,YAA1B;AACAnB,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;kCAEaa,G,EAAKC,K,EAAO;AACxB,UAAMvB,OAAO,CAACsB,GAAD,EAAMC,KAAN,CAAb;AACA,WAAKlD,MAAL,CAAY+B,IAAZ,CAAiB,eAAjB,EAAkCJ,IAAlC;AACD;;;kCAEaA,I,EAAM;AAAA,iCACGA,IADH;AAAA,UACXsB,GADW;AAAA,UACNC,KADM;;AAElB,WAAKrE,IAAL,CAAUI,aAAV,CAAwBkE,gBAAxB,CAAyCF,GAAzC,IAAgDC,KAAhD;AACAtB,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;kCAEa;;AAEZ,UAAMgB,IAAIxB,IAAIO,QAAJ,CAAakB,WAAb,EAAV;AACA,UAAGD,CAAH,EAAM;AACJ,aAAKpD,MAAL,CAAY+B,IAAZ,CAAiB,aAAjB,EAAgCqB,CAAhC;AACD;AAEF;;;gCAEWpE,Q,EAAU;AACpB,WAAKH,IAAL,CAAUG,QAAV,GAAqBA,QAArB;AACA4C,UAAIO,QAAJ,CAAaC,MAAb;AACD;;;oCAEe;AACd,WAAKpC,MAAL,CAAY+B,IAAZ,CAAiB,eAAjB;AACD;;;sCAEiB;AAChB,WAAKlD,IAAL,CAAUG,QAAV,GAAqB,IAArB;AACA4C,UAAIO,QAAJ,CAAaC,MAAb;AACD;;AAID;;;;gCACYkB,S,EAAW;;AAErB,WAAKzE,IAAL,CAAU0E,OAAV,GAAoB,IAApB;;AAEA3B,UAAI4B,QAAJ,GAAe,CAAC,KAAKhE,IAAL,CAAUC,QAA1B;AACAmC,UAAI6B,IAAJ,GAAWC,cAAcC,MAAd,CAAqBL,SAArB,EAAgC,KAAKxD,OAArC,CAAX;AACA8B,UAAIgC,OAAJ,CAAYC,UAAZ,CAAuBC,EAAER,UAAUhE,OAAZ,EAAqByE,MAArB,CAA4B;AAAA,eAAKX,EAAE,CAAF,MAASxB,IAAIpC,IAAJ,CAASqC,EAAvB;AAAA,OAA5B,EAAuD3C,GAAvD,CAA2D;AAAA,eAAK,CAACkE,EAAE,CAAF,CAAD,EAAOA,EAAE,CAAF,CAAP,CAAL;AAAA,OAA3D,CAAvB;AACA,WAAKtD,OAAL,CAAakE,MAAb;;AAEAC,YAAMC,cAAN,CAAqB,YAAI;AACvBtC,YAAI6B,IAAJ,CAASU,KAAT;AACAF,cAAMG,YAAN;AACD,OAHD;AAID;;;8BAESC,O,EAAS;;AAEjBC,cAAQC,GAAR,CAAYF,OAAZ;;AAEA,WAAK7E,IAAL,CAAUE,OAAV,GAAoB,KAApB;AACA,WAAKb,IAAL,CAAU0E,OAAV,GAAoB,KAApB;;AAEA,WAAKzD,OAAL,CAAa0E,aAAb;;AAEA5C,UAAI6B,IAAJ,CAASgB,GAAT;AACAR,YAAMS,QAAN;;AAEAC,iBAAW,YAAM;;AAEfV,cAAMW,WAAN,CAAkBP,OAAlB;AAED,OAJD,EAIGQ,KAAKC,GAAL,CAAS,CAAT,CAJH;;AAMA;AACD;;;mCAGc,CAAE;;;iCAIJ;;AAEX;AACA;AACA,UAAMC,YAAY,KAAKlG,IAAL,CAAU0E,OAA5B;AACA,UAAMyB,YAAY,KAAKvF,QAAvB;AACA,UAAMwF,gBAAgB,KAAKpG,IAAL,CAAUC,IAAV,IAAkB,CAAxC;AACA,UAAGiG,aAAaC,SAAb,IAA0BC,aAA7B,EACErD,IAAIsD,OAAJ,CAAY3B,OAAZ,GAAsB,IAAtB,CARS,CAQmB;AAE/B;;;;;;AAOH4B,EAAE,YAAI;;AAEJ;;AAEA;AACEvD,MAAIgC,OAAJ,GAAc,IAAIwB,OAAJ,EAAd;AACAxD,MAAIyD,KAAJ,GAAY,IAAIzG,KAAJ,EAAZ;AACAgD,MAAIO,QAAJ,GAAe,IAAImD,OAAJ,EAAf;;AAEF;AACE1D,MAAIyD,KAAJ,CAAUhF,OAAV;;AAEF;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;;AAGA;;AAGD,CA9BD;;AAsCA;;IACMiF,O;AAEJ,qBAAc;AAAA;AAAE;;;;+BAEL;;AAET,UACEC,QAAQ,YADV;AAAA,UAEEC,aAAa,SAAbA,UAAa,OAAQ;AACnB;AACA,YAAG,CAAE,aAAaC,IAAb,CAAkB3D,IAAlB,CAAL,EAA+B,OAAO,KAAP;;AAE/B;AACA,YAAG4D,SAASC,OAAT,CAAiB7D,IAAjB,CAAH,EAA2B,OAAO,KAAP;;AAE3B,eAAO,IAAP;AACD,OAVH;;AAYA,UAAIA,OAAOF,IAAIpC,IAAJ,CAASsC,IAApB;AACA,aAAM,CAACA,IAAD,IAAUA,KAAK8D,IAAL,OAAc,EAAxB,IAA+B,CAACJ,WAAW1D,IAAX,CAAtC,EAAwD;AACtDA,eAAO7B,OAAO+B,MAAP,CAAc,6BAAd,CAAP;AACD;;AAED,WAAKF,IAAL,GAAYA,KAAK8D,IAAL,EAAZ;AACAC,cAAQ/D,IAAR;AAID;;;8BAEuG;AAAA,UAAhGgE,cAAgG,uEAA/ElE,IAAIyD,KAAJ,CAAUxG,IAAV,CAAeI,aAAf,CAA6B8G,mBAA7B,CAAiDC,QAA8B;AAAA,UAApBC,WAAoB,uEAAN,IAAM;;AACtG,UAAIC,SAASjG,OAAO+B,MAAP,qCAAgD8D,cAAhD,uBAAb;AACA,UAAGI,WAAW,EAAd,EAAkBA,SAAS,CAAT,CAFoF,CAExE;;AAE9B,UAAMC,qBAAqBD,WAAW,IAAtC;AACA,UAAME,eAAeC,MAAM,IAAIC,MAAJ,CAAWJ,MAAX,CAAN,CAArB;AACA,UAAMK,gBAAgBL,SAAS,CAA/B;AACA,UAAMM,eAAeN,SAASJ,cAA9B;;AAEA,UAAGK,sBAAsBC,YAAtB,IAAsCG,aAAtC,IAAuDC,YAA1D,EAAwE,OAAO,IAAP;AACxE,aAAON,MAAP;AACD;;;kCAEa;;AAEZ,UAAMlH,WAAWiB,OAAO+B,MAAP,CAAc,0BAAd,EAA0C,MAA1C,CAAjB;;AAEA,UAAG,UAAUyD,IAAV,CAAezG,QAAf,CAAH,EAA6B;;AAE3B;AACA,eAAOA,QAAP;AAED,OALD,MAKO,IAAGA,aAAa,IAAhB,EAAsB;;AAE3B;AACA;AAED,OALM,MAKA;;AAEL;AACAiB,eAAOM,KAAP,CAAa,oCAAb;AACA;AAED;AAIF;;;6BAGQ;AACPkG,eAASrE,MAAT,CACE,oBAAC,WAAD,IAAa,cAAcR,IAAIyD,KAAJ,CAAUxG,IAArC,EAA2C,QAAQ+C,IAAIyD,KAAJ,CAAU7F,IAAV,CAAeC,QAAlE,EAA4E,OAAOmC,IAAIyD,KAAJ,CAAU7F,IAAV,CAAeE,OAAlG,GADF,EAEEgH,SAASC,cAAT,CAAwB,WAAxB,CAFF;AAID;;;;;;AA2BH","file":"client.js","sourcesContent":["\n// client.js\n// by David Ruiz\n// Copyright DEEP SPACE All Rights Reserved 2017\n\n\nclass Lobby {\n\n  constructor() {\n\n    this.info = {\n      type: null,\n      code: null,\n      password: null,\n      game_settings: {\n        map: null,\n        player_capacity: null,\n        mode: null,\n        stock: null\n      },\n      players: [\n        // {name, rank, team, ready, ship, slots []}\n      ],\n      spectators: [\n        // {name?}\n      ]\n    };\n\n    this.user = {\n      isJoined: false,\n      isReady: false,\n      team: null,\n    };\n    this.userIsJoined = false;\n\n    this.socketSetup();\n    this.network = new GameNetworkAdapter(null, this.socket)\n\n    window.onbeforeunload = () => this.beforeExit();\n\n  }\n\n  socketSetup() {\n    let socket = this.socket = io.connect();\n\n    socket.on('pie', ()=>{alert('received')});\n    socket.on('error', (msg)=>{alert(`server error -- ${msg}`)});\n\n    // setting up responses`\n\n    // connect -> auth\n    // connect -> connected\n    socket.on('auth', (a)=>this.auth(a));\n    socket.on('connected', (a)=>this.connected(a));\n    socket.on('passwordSet', (a)=>this.passwordSet(a));\n    socket.on('passwordCleared', (a)=>this.passwordCleared(a));\n\n    socket.on('joined', (a)=>this.joined(a));\n    socket.on('lobbyFull', (a)=>this.lobbyFull(a));\n    socket.on('starting', (a)=>this.starting(a));\n\n    socket.on('usersUpdate', (a)=>this.usersUpdate(a));\n    socket.on('playersUpdate', (a)=>this.playersUpdate(a));\n    socket.on('optionsUpdate', (a)=>this.optionsUpdate(a));\n\n    socket.on('gameStarted', (a)=>this.gameStarted(a));\n    socket.on('gameEnded', (a)=>this.gameEnded(a));\n\n    socket.on('disconnected', (a)=>this.disconnected(a));\n  }\n\n\n  connect() {\n\n    // connect to specific lobby presenting id and name\n    let lobbyID = window.location.pathname.slice(1),\n        // [lobby_id, user_id, user_name];\n\n        data = [lobbyID, ENV.user.id, ENV.user.name];\n\n    this.socket.emit('connect', data);\n  }\n\n  auth() {\n\n    let password = window.prompt('This lobby requires a password. Enter it here:');\n\n    // if dialog was canceled, return home\n    if(password === null) {\n      history.back();\n      return;\n    }\n    \n    // connect to specific lobby presenting id and name\n    let lobbyID = window.location.pathname.slice(1),\n      // [lobby_id, user_id, user_name];\n      data = [lobbyID, password];\n\n    this.socket.emit('auth', data);\n  }\n\n  connected(data) {\n    // data [user_id, lobby_object]\n\n    ENV.user.id = data[0];\n\n    this.info = data[1];\n\n    // ENV.UI.init();\n    ENV.lobby_ui.render();\n\n    // NOTE NOTE NOTE: if the lobby is public or private automatically join as\n    // there was always room for you as intended.\n    const lobbyType = this.info.type;\n    if(lobbyType == 0 || lobbyType == 2) this.join();\n  }\n\n  join() {\n\n    // OLD\n    // the prerequisits for joining are:\n    // {name, rank, team, ready, ship, slots []}\n\n    // NEW\n    // the prerequisits for joining are:\n    // {name, rank, team}\n\n    // :name\n    if(!ENV.user.name) ENV.UA.getName();\n\n    // :team\n    switch(this.info.type) {\n      case 0: // public\n        this.user.team = null;\n        break;\n      case 1: // private\n        if((this.user.team = ENV.lobby_ui.getTeam()) === null) return;\n        break;\n      case 2: // practice\n        this.user.team = 0;\n        break;\n    }\n\n    // :rank\n    ENV.user.get_rank.then(rank => {\n\n      let data = [ENV.user.name, rank, this.user.team];\n      this.socket.emit('join', data);\n\n    }).catch(()=>{\n      alert('An error occurred...')\n    });\n\n\n    // connect to specific lobby presenting id and name\n    // let lobbyID = window.location.pathname.slice(1),\n    //   // [lobby_id, user_id, user_name];\n    //\n    //   data = [ENV.user.name, shipType];\n    //\n    // this.socket.emit('join', data);\n\n  }\n\n  joined() {\n    this.user.isJoined = true;\n    ENV.lobby_ui.render();\n  }\n\n  lobbyFull() {\n    ENV.lobby_ui.render();\n  }\n\n  start(shipType) {\n\n    // future prerequisits for starting are:\n    // {shipType, [slots]}\n\n    // the prerequisits for starting are:\n    // {shipType}\n\n    this.socket.emit('start', shipType);\n\n  }\n\n  starting() {\n    this.user.isReady = true;\n    ENV.lobby_ui.render();\n  }\n\n  usersUpdate(newUsersData) {\n    this.info.users = newUsersData;\n    ENV.lobby_ui.render();\n  }\n\n  playersUpdate(newUsersData) {\n    this.info.users.players = newUsersData;\n    ENV.lobby_ui.render();\n  }\n\n  updateOptions(key, value) {\n    const data = [key, value];\n    this.socket.emit('updateOptions', data);\n  }\n\n  optionsUpdate(data) {\n    const [key, value] = data;\n    this.info.game_settings.editableSettings[key] = value;\n    ENV.lobby_ui.render();\n  }\n\n  setPassword() {\n\n    const p = ENV.lobby_ui.getPassword();\n    if(p) {\n      this.socket.emit('setPassword', p);\n    }\n\n  }\n\n  passwordSet(password) {\n    this.info.password = password;\n    ENV.lobby_ui.render();\n  }\n\n  clearPassword() {\n    this.socket.emit('clearPassword');\n  }\n  \n  passwordCleared() {\n    this.info.password = null;\n    ENV.lobby_ui.render();\n  }\n\n\n\n  // on game start\n  gameStarted(setupData) {\n\n    this.info.ongoing = true;\n\n    ENV.spectate = !this.user.isJoined;\n    ENV.game = DeepSpaceGame.create(setupData, this.network);\n    ENV.friends.addHistory(_(setupData.players).reject(p => p[0] === ENV.user.id).map(p => [p[0], p[1]]));\n    this.network.listen();\n\n    LOBBY.startCountdown(()=>{\n      ENV.game.start();\n      LOBBY.refreshClock();\n    })\n  }\n\n  gameEnded(results) {\n\n    console.log(results);\n\n    this.user.isReady = false;\n    this.info.ongoing = false;\n\n    this.network.stopListening();\n\n    ENV.game.end();\n    LOBBY.hideGame();\n\n    setTimeout(() => {\n\n      LOBBY.showResults(results);\n\n    }, TIME.sec(2));\n\n    // this.game.end();\n  }\n\n\n  disconnected() {}\n\n\n\n  beforeExit() {\n\n    // as a user closes the window..\n    // - record if they leave a team alone\n    const isOngoing = this.info.ongoing;\n    const isPlaying = this.isJoined;\n    const isPublicLobby = this.info.type == 0;\n    if(isOngoing && isPlaying && isPublicLobby)\n      ENV.storage.ongoing = true; // save in local storage TODO revise\n\n  }\n\n}\n\n\n\n\n$(()=>{\n\n  // A client loads a lobby page..\n\n  //-1. instantiate lobby (app)\n    ENV.friends = new Friends();\n    ENV.lobby = new Lobby();\n    ENV.lobby_ui = new LobbyUI();\n\n  // 0. open a connection with server\n    ENV.lobby.connect();\n\n  // 1. a valid id and valid name is sent\n  //    response is either lobby data or denial\n  //    remains in limbo state with frame only but not active\n\n  // 2. if game is active, client is asked about continuing\n  //    once accepted, lobby information is sent to client\n  //    option to join is available\n\n  // 3. request to join is sent\n  //    response is either unable or simply success\n\n  // 4. upon joining, player information is sent and options locked\n  //\n\n\n  //    popup handling place?\n\n\n});\n\n\n\n\n\n\n\n// handles lobby code about ui\nclass LobbyUI {\n\n  constructor() {}\n\n  get_name() {\n\n    const\n      regex = /^(\\w|\\s)+$/,\n      validation = name => {\n        // only alphanumeric and whitespace characters\n        if(!(/^(\\w|\\s)+$/.test(name))) return false;\n\n        // no profanity\n        if(swearjar.profane(name)) return false;\n\n        return true;\n      };\n\n    let name = ENV.user.name;\n    while(!name || (name.trim()===\"\") || !validation(name)) {\n      name = window.prompt('please enter a display name');\n    }\n\n    this.name = name.trim();\n    resolve(name);\n\n\n\n  }\n\n  getTeam(max_team_count = ENV.lobby.info.game_settings.noneditableSettings.maxTeams, solo_option = true) {\n    let result = window.prompt(`Type your team # between 1 and ${max_team_count} (blank for none)` );\n    if(result === '') result = 0; // shortcut for solo\n\n    const userCanceledDialog = result === null;\n    const isNotANumber = isNaN(new Number(result));\n    const isUnderBounds = result < 0;\n    const isOverBounds = result > max_team_count;\n\n    if(userCanceledDialog || isNotANumber || isUnderBounds || isOverBounds) return null;\n    return result;\n  }\n\n  getPassword() {\n\n    const password = window.prompt('Enter a 4 digit password', '0000');\n\n    if(/^\\d{4}$/.test(password)) {\n\n      // success\n      return password\n\n    } else if(password === null) {\n\n      // cancel\n      return\n\n    } else {\n\n      // failure\n      window.alert('Not 4 numbers, please try again...');\n      return\n\n    }\n\n    \n\n  }\n\n\n  render() {\n    ReactDOM.render(\n      <DSGameLobby lobbySummary={ENV.lobby.info} joined={ENV.lobby.user.isJoined} ready={ENV.lobby.user.isReady} />,\n      document.getElementById('container')\n    );\n  }\n\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n/*\n\n\n\n\n\n// NETWORK INTERACTION\n\n// CONNECT TO server\nlet socket = io.connect();\n\nsocket.on('onconnected', function(obj) {\n  if(ENV.user.id === undefined) ENV.user.id = obj.id;\n  socket.emit('userid', ENV.user.id);\n  ENV[\"id\"] = ENV.user.id;\n\n  // REQUEST JOIN lobby\n  let lobbyID = window.location.pathname.slice(1);\n  socket.emit('join lobby', lobbyID);\n\n  // send stored info\n  let name = ENV.storage.user_name || \"\";\n  socket.emit('set name', name);\n\n  let type = ENV.storage.type || \"standard\"; // TODO: double hard-coded see view.js:36\n  if(type) socket.emit('set type', type);\n\n  // if(sessionStorage.ready = !!(sessionStorage.nickname && sessionStorage.type)) socket.emit('ready');\n\n  LOBBY.setupLink();\n  LOBBY.focusOnInput();\n});\n\nsocket.on('lobby joined', lobby_type => {\n  if(lobby_type == 'private') {\n    let team = ENV.storage.team || -1; // TODO: double hard-coded see view.js:36\n    if(team) socket.emit('set team', team);\n  }\n})\n\n// handle errors\nsocket.on('error', msg => log(msg));\nsocket.on('game error', msg => LOBBY.disconnect(msg));\n\n// on join lobby\nlet editing;\nsocket.on('lobby state', lobby => {\n  // log(`lobby state`);\n  // log(lobby.players);\n  ENV[\"lobby\"] = lobby;\n  let me = lobby.players[ENV.storage.id];\n  if(me) ENV.user.name = me.name;\n  if(!editing) refreshLobbyView();\n});\n\nsocket.on('spectate', function() {\n  if(confirm(\"This lobby is closed. Join as a spectator?\")) {\n    ENV[\"spectate\"] = true;\n  } else {\n    window.location.reset()\n  }\n});\n\nsocket.on('ready', () => {\n  // LOBBY.disableInput();\n});\n\n// socket.on('disconnect', () => LOBBY.disconnect(`you are no longer connected`));\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// NEEDS WORK\nlet CODE = {};\n\n// START game\n\nCODE.start_game = function(data) {\n\n  if(!ENV.lobby) { setTimeout(()=>{CODE.start_game(data)}, 100); return; }\n\n  recordHistory(data);\n\n  data.spectate = !!ENV[\"spectate\"];\n  ENV.sound.stop('chill');\n  if(ENV.lobby.type == 'public' && !ENV.spectate) ENV.storage.ongoing = 'true';\n  if(!ENV.storage.first_game  && !ENV.spectate) { ENV.help.drawer.expand(); ENV.help.carousel.start(); ENV.storage.first_game = true; }\n  g = ENV.game = DeepSpaceGame.create(data);\n  LOBBY.startCountdown(()=>{\n    PARTICLES.stop();\n    LOBBY.showHelpButton();\n  \tENV.game.start();\n  \tLOBBY.refreshClock();\n  })\n};\n\nsocket.on('start', CODE.start_game);\n\n// during game\n\n// socket.on('input stack', (data) => NetworkHelper.in_input_stack(data));\nsocket.on('ship update', (data) => NetworkHelper.in_ship_update(data));\nsocket.on('ship override', (data) => NetworkHelper.in_ship_override(data));\nsocket.on('bullet create', (data) => NetworkHelper.in_bullet_create(data));\nsocket.on('bullet destroy', (data) => NetworkHelper.in_bullet_destroy(data));\nsocket.on('ship damage', (data) => NetworkHelper.in_ship_damage(data));\nsocket.on('block create', (data) => NetworkHelper.in_block_create(data));\nsocket.on('block destroy', (data) => NetworkHelper.in_block_destroy(data));\nsocket.on('block damage', (data) => NetworkHelper.in_block_damage(data));\nsocket.on('block change', (data) => NetworkHelper.in_block_change(data));\n\nsocket.on('sub create', (data) => NetworkHelper.in_sub_create(data));\nsocket.on('sub destroy', (data) => NetworkHelper.in_sub_destroy(data));\n\nsocket.on('flag pickup', (data) => NetworkHelper.in_flag_pickup(data));\nsocket.on('flag drop', (data) => NetworkHelper.in_flag_drop(data));\n\nsocket.on('msg ship kill', (data) => NetworkHelper.in_msg_ship_kill(data));\n\nsocket.on('stop', () => delete DeepSpaceGame.runningInstance);\n\nsocket.on('game over', (data) => NetworkHelper.end_game());\nsocket.on('request progress', (data) => NetworkHelper.request_local_progress());\nsocket.on('overtime', () => NetworkHelper.go_overtime());\n\nsocket.on('disconnect player', (userid) => NetworkHelper.in_disconnect_player(userid));\n\nfunction recordHistory(data) {\n  let pp = ENV.storage.getItem(\"previous_players\");\n\n  if(pp) { pp = JSON.parse(pp).toSet() } else { pp = new Set() }\n  for(let player of data.players) if(player.id !== ENV[\"id\"]) {pp.delete(player.id); pp.add(player.id);}//pp.add(`${player.id}::${player.name}`);\n\n  ENV.storage.setItem(\"previous_players\", JSON.stringify(pp.toArray()));\n}\n*/"]}